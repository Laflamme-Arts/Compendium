<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ALTERA Basic Rules Compendium</title>
<style>
:root{
  --bg:#0b0c0f;
  --panel:#111521;
  --muted:#0f131b;
  --border:#2a3042;
  --line:#1e2230;
  --text:#e6e6e6;
  --sub:#a9b7d0;
  --brand:#a8c8ff;
  --header-h: 60px;
  --legal-h: 80px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom:var(--legal-h)}
header{padding:14px 20px;border-bottom:1px solid var(--line);background:#12141a;position:sticky;top:0;z-index:20;display:flex;gap:14px;align-items:center}
header img.logo{height:32px;width:auto}
h1{margin:0;font-size:20px;font-weight:700}
.small{color:var(--sub);font-size:12px}
.app{display:flex;min-height:calc(100vh - var(--header-h))}

/* Sidebar fixed between header and legal footer */
#chaptersSidebar{
  position:fixed;left:0;top:var(--header-h);bottom:var(--legal-h);
  width:280px;padding:12px;overflow:auto;background:#0e1118;border-right:1px solid var(--line)
}
#chaptersSidebar h2{font-size:14px;margin:8px 6px;color:#9fb2d8}
#chaptersSidebar details{margin:6px 0;border:1px solid var(--border);border-radius:10px;background:var(--panel);overflow:hidden}
#chaptersSidebar summary{padding:8px 10px;cursor:pointer}
#chaptersSidebar a{display:block;padding:6px 12px 6px 18px;text-decoration:none;color:var(--brand);border-top:1px solid var(--line)}
#chaptersSidebar a:hover{text-decoration:underline}

/* Main content leaves room for sidebar */
.container{flex:1;max-width:1100px;margin:0 auto;padding:16px 20px;margin-left:300px}
.card{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);margin-bottom:14px}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
.detail{white-space:pre-wrap;line-height:1.35}
.section{margin:10px 0;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0f0f16}
.section h3{margin:0 0 6px 0}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
select{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--muted);color:var(--text)}

/* No-JS safety */
.no-js #chaptersContent .card.fallback{display:block}
.no-js #chaptersContent .js-note{display:none}

/* Fixed legal footer */
#legalFooter{
  position:fixed;left:0;right:0;bottom:0;z-index:30;
  background:#0d0f14;border-top:1px solid var(--line);
  padding:6px 12px;font-size:10px;line-height:1.3;color:#9aa3b2;
}
</style>
</head>
<body class="no-js">
<header>
  <h1 id="siteTitle">ALTERA Basic Rules Compendium</h1>
</header>

<div class="app">
  <aside id="chaptersSidebar">
    <h2>Chapters</h2>
    <div class="small">Click a section to view text.</div>
  </aside>

  <main class="container">
    <div id="chaptersContent">
      <div class="card fallback">Site loaded. When you add your CSV links in CONFIG, chapters and sections will appear here.</div>
      <div class="card js-note">Tip: fill <b>BookChapters.intro_text</b> and <b>BookSections.body_text</b> in your sheet to display text.</div>
    </div>
  </main>
</div>

<div id="legalFooter">
  ALTERA, Basic Rules, Laflamme Arts, and all other Laflamme Arts product names, and their respective logos are trademarks of Laflamme Arts
  in Canada, the USA and other countries. All characters and their distinctive likenesses are the property of Laflamme Arts Inc.
  This material is protected under the copyright laws of Canada. Any reproduction or unauthorized use of the material or artwork contained
  herein is prohibited without the express written permission of Laflamme Arts Inc.
</div>

<script>
/* Boot basics */
try{ document.body.classList.remove('no-js'); }catch(e){}
const CONFIG = {
  chapters_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMxvcKAe9M8AzsoGrnwKN_KwfKpgFOcvt7NdumECU9t4MDrOUHySJHRUu0pAb8QYrFuJALE-C6z2LW/pub?gid=929214790&single=true&output=csv",   // BookChapters CSV
  sections_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMxvcKAe9M8AzsoGrnwKN_KwfKpgFOcvt7NdumECU9t4MDrOUHySJHRUu0pAb8QYrFuJALE-C6z2LW/pub?gid=1669690030&single=true&output=csv",   // BookSections CSV
  talents_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMxvcKAe9M8AzsoGrnwKN_KwfKpgFOcvt7NdumECU9t4MDrOUHySJHRUu0pAb8QYrFuJALE-C6z2LW/pub?gid=1725231224&single=true&output=csv",    // Talents CSV
  glossary_csv: "",   // optional
  theme_csv: ""       // optional
};

function updateLayoutVars(){
  const root = document.documentElement;
  const header = document.querySelector('header');
  const footer = document.getElementById('legalFooter');
  if(header) root.style.setProperty('--header-h', header.offsetHeight + 'px');
  if(footer) root.style.setProperty('--legal-h', footer.offsetHeight + 'px');
}
window.addEventListener('load', updateLayoutVars);
window.addEventListener('resize', updateLayoutVars);

/* CSV helpers */
function parseCSV(text){
  const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l!=='');
  if(!lines.length) return [];
  const headers = splitCSVLine(lines[0]);
  const out = [];
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const row = {};
    headers.forEach((h,idx)=> row[h] = (cols[idx]??"").trim());
    out.push(row);
  }
  return out;
}
function splitCSVLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
      else inQ=!inQ;
    } else if(ch===',' && !inQ){
      out.push(cur); cur="";
    } else cur+=ch;
  }
  out.push(cur);
  return out;
}
async function fetchCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed');
  return parseCSV(await res.text());
}

/* Normalizers */
function normChapters(rows){
  return rows.map(r=>({
    chapter_slug:(r.chapter_slug||"").trim(),
    chapter_number:(r.chapter_number||"").trim(),
    chapter_title:(r.chapter_title||"").trim(),
    short_title:(r.short_title||"").trim() || (r.chapter_title||"").trim(),
    intro_text:(r.intro_text||"").trim(),
    order:Number(r.order||0)||0
  })).filter(r=>r.chapter_slug);
}
function normSections(rows){
  return rows.map(r=>({
    section_slug:(r.section_slug||"").trim(),
    chapter_slug:(r.chapter_slug||"").trim(),
    section_number:(r.section_number||"").trim(),
    section_title:(r.section_title||"").trim(),
    body_text:(r.body_text||"").trim(),
    order:Number(r.order||0)||0,
    ui_hint:(r.ui_hint||"static").trim().toLowerCase()
  })).filter(r=>r.section_slug && r.chapter_slug);
}
function normTalents(rows){
  return rows.map(r=>({
    id_slug:r.id_slug||"", name:r.name||"", type:(r.type||"").toLowerCase(), overview_1line:r.overview_1line||""
  }));
}

/* Rendering */
function renderBook(chapters, sections){
  // Sidebar
  const side = document.getElementById('chaptersSidebar');
  side.innerHTML = '<h2>Chapters</h2>';
  chapters.sort((a,b)=>a.order-b.order).forEach(ch=>{
    const det = document.createElement('details');
    det.open = true;
    det.innerHTML = `<summary>${ch.chapter_number?`Chapter ${ch.chapter_number} — `:''}${ch.short_title||ch.chapter_title}</summary>`;
    const secs = sections.filter(s=>s.chapter_slug===ch.chapter_slug).sort((a,b)=>a.order-b.order);
    secs.forEach(s=>{
      const a = document.createElement('a');
      a.href = `#sec/${s.section_slug}`;
      a.textContent = `${s.section_number? s.section_number+' ' : ''}${s.section_title}`;
      det.appendChild(a);
    });
    side.appendChild(det);
  });

  // Main content
  const wrap = document.getElementById('chaptersContent');
  wrap.innerHTML = '';
  chapters.forEach(ch=>{
    const art = document.createElement('article');
    art.className='card';
    art.id = `chap-${ch.chapter_slug}`;
    art.innerHTML = `<h2 style="margin:0 0 8px 0">${ch.chapter_number?`Chapter ${ch.chapter_number} — `:''}${ch.chapter_title}</h2>`
                  + (ch.intro_text? `<div class="detail" style="margin-bottom:8px">${ch.intro_text}</div>` : '');
    const secs = sections.filter(s=>s.chapter_slug===ch.chapter_slug).sort((a,b)=>a.order-b.order);
    secs.forEach(s=>{
      const sec = document.createElement('section');
      sec.className='section';
      sec.id = `sec-${s.section_slug}`;
      sec.innerHTML = `<h3>${s.section_number? s.section_number+' ' : ''}${s.section_title}</h3>`
                    + `<div class="detail">${(s.body_text||'').replace(/\n/g,'\n')}</div>`;

      // Inject talent selectors inside the "Selecting talents" section
      if(s.section_slug === 'ch2-selecting-talents'){
        const inject = document.createElement('div');
        inject.className = 'card';
        inject.id = 'selecting-talents';
        inject.innerHTML = `
          <h3 style="margin:0 0 8px 0">Selecting talents</h3>
          <div class="grid">
            <div class="card">
              <label><b>Mental</b></label>
              <select id="sel-mental"><option value="">Choose a talent…</option></select>
              <div class="small" id="detail-mental" style="margin-top:6px"></div>
            </div>
            <div class="card">
              <label><b>Physical</b></label>
              <select id="sel-physical"><option value="">Choose a talent…</option></select>
              <div class="small" id="detail-physical" style="margin-top:6px"></div>
            </div>
            <div class="card">
              <label><b>Professional</b></label>
              <select id="sel-professional"><option value="">Choose a talent…</option></select>
              <div class="small" id="detail-professional" style="margin-top:6px"></div>
            </div>
            <div class="card">
              <label><b>Passion</b></label>
              <select id="sel-passion"><option value="">Choose a talent…</option></select>
              <div class="small" id="detail-passion" style="margin-top:6px"></div>
            </div>
          </div>`;
        sec.appendChild(inject);
      }
      art.appendChild(sec);
    });
    wrap.appendChild(art);
  });
}

function handleHash(){
  const h = location.hash.slice(1);
  if(!h) return;
  const [kind, slug] = h.split('/');
  if(kind==='sec'){
    const el = document.getElementById('sec-'+slug);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  } else if(kind==='chap'){
    const el = document.getElementById('chap-'+slug);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
}
window.addEventListener('hashchange', handleHash);

/* Talents dropdowns */
function initTalentSelectors(talents){
  const group = { mental:[], physical:[], professional:[], passion:[] };
  talents.forEach(t => { const tp=(t.type||'').toLowerCase(); if(group[tp]) group[tp].push(t); });
  Object.keys(group).forEach(k => group[k].sort((a,b)=> (a.name||'').localeCompare(b.name||'')));

  function fill(id, items, detailId){
    const sel = document.getElementById(id);
    const box = document.getElementById(detailId);
    if(!sel || !box) return;
    sel.innerHTML = '<option value="">Choose a talent…</option>' + items.map(t => `<option value="${t.id_slug}">${t.name}</option>`).join('');
    sel.onchange = () => {
      const slug = sel.value;
      if(!slug){ box.innerHTML=''; return; }
      const t = items.find(x => x.id_slug===slug);
      if(!t){ box.innerHTML=''; return; }
      box.innerHTML = `<b>${t.name}</b><div>${t.overview_1line||''}</div>`;
    };
  }
  fill('sel-mental', group.mental, 'detail-mental');
  fill('sel-physical', group.physical, 'detail-physical');
  fill('sel-professional', group.professional, 'detail-professional');
  fill('sel-passion', group.passion, 'detail-passion');
}

/* Boot */
async function init(){
  updateLayoutVars();

  let chapters=[], sections=[], talents=[];
  try{ if(CONFIG.chapters_csv) chapters = normChapters(await fetchCSV(CONFIG.chapters_csv)); }catch(e){}
  try{ if(CONFIG.sections_csv) sections = normSections(await fetchCSV(CONFIG.sections_csv)); }catch(e){}
  try{ if(CONFIG.talents_csv) talents = normTalents(await fetchCSV(CONFIG.talents_csv)); }catch(e){}

  if(chapters.length || sections.length){
    renderBook(chapters, sections);
    handleHash();
  }

  if(talents.length){
    // Fill dropdowns if "Selecting talents" block exists
    initTalentSelectors(talents);
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
